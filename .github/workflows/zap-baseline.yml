name: ZAP Full DAST Scan and AI Reporting

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 2 * * 1" # Run every Monday at 02:00 UTC

jobs:
  ai-dast-report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      # 1. Caching and Python Setup (Step 1)
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üì¶ Cache Python Dependencies
        id: cache-pip
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          path: ${{ env.pythonLocation }}

      - name: ‚öôÔ∏è Install Python Dependencies (If Cache Missed)
        if: steps.cache-pip.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 2. Perform OWASP ZAP Full Scan (Step 2)
      - name: üõ°Ô∏è Run ZAP Full Scan
        id: zap_scan
        uses: zaproxy/action-full-scan@v0.13.0 # Using latest stable version
        with:
          # Use the TARGET_URL variable from your GitHub Environment
          target: ${{ vars.TARGET_URL }}
          rules_file_name: .zap/rules.tsv
          cmd_options: '-m 10 -r report.html -J report.json' # Scan for 10 mins, output HTML/JSON
          allow_issue_writing: false
          fail_action: false

      # 3. Upload Reports (Optional but Recommended)
      - name: ‚¨ÜÔ∏è Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report.html
            report.json

      # 4. AI Processing and Slack Reporting (Steps 3 & 4)
      - name: ü§ñ Send AI-Powered Slack Report with Remediation
        env:
          # Pass the AI key as a secret
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Pass the Slack Webhook as a secret
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # The script logic handles the AI prompt and Slack formatting internally
          USE_AI_CLASSIFICATION: true
        run: |
          python slack_reporter_full.py report.json javascript
