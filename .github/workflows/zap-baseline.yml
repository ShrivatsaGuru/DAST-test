name: üõ°Ô∏è ZAP DAST Scan with AI Analysis

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 2 * * 1" # Runs every Monday at 02:00 UTC

env:
  # Ensure TARGET_URL is set in your Repo Settings -> Secrets and variables -> Variables
  TARGET_URL: ${{ vars.TARGET_URL }} 
  RULES_FILE: .zap/rules.tsv

jobs:
  zap-scan-and-analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write 
    
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      # --- Python Setup & Caching ---
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üì¶ Cache Pip Dependencies
        id: cache-pip
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-pip-cache-${{ hashFiles('requirements.txt') }}
          path: ~/.cache/pip

      - name: ‚öôÔ∏è Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          # Ensure 'google-genai' is in your requirements.txt
          pip install -r requirements.txt --cache-dir ~/.cache/pip

      # --- 1. OWASP ZAP Scan ---
      - name: üõ°Ô∏è Run ZAP Full Scan
        id: zap_scan
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: ${{ env.RULES_FILE }}
          cmd_options: >-
            -m 10 
            -r zap_report.html 
            -J zap_report.json 
            -a 
          fail_action: false # Don't stop yet; we need to run the AI analysis

      # --- 2. Fix Permissions (Crucial Fix) ---
      - name: ‚öôÔ∏è Fix Report Permissions
        run: |
          # Use sudo to fix the file owned by the Docker root user
          sudo chmod a+rw zap_report.json
          sudo chmod a+rw zap_report.html
          ls -l zap_report.json # Verify file exists and is readable

      # --- 3. AI Analysis (Gemini) ---
      - name: ü§ñ Run Gemini AI Security Analyst
        if: always() # Run even if ZAP found vulnerabilities
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} 
        run: |
          # This script reads zap_report.json and outputs ai_report.json
          python ai_analyst.py zap_report.json

      # --- 4. Upload Artifacts ---
      - name: ‚¨ÜÔ∏è Upload DAST Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-security-reports
          path: |
            zap_report.html
            zap_report.json
            ai_report.json

            
      - name: üîî Send Slack Notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python - <<'EOF'
          import os
          import json
          import urllib.request
      
          try:
              with open("ai_report.json", "r") as f:
                  data = json.load(f)
      
              report_text = json.dumps(data, indent=2)
      
              payload = {
                  "channel": "#reports",
                  "username": "Gemini Security Analyst",
                  "text": (
                      "*üõ°Ô∏è ZAP DAST Scan & Gemini Analysis*\n"
                      "Here are the AI-generated insights:\n\n"
                      f"```json\n{report_text}\n```"
                  )
              }
      
              req = urllib.request.Request(
                  os.environ["SLACK_WEBHOOK_URL"],
                  data=json.dumps(payload).encode("utf-8"),
                  headers={"Content-Type": "application/json"}
              )
      
              urllib.request.urlopen(req)
              print("‚úÖ Slack notification sent to #reports.")
      
          except Exception as e:
              print(f"‚ö†Ô∏è Failed to send Slack notification: {e}")
          EOF
