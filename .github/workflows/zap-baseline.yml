name: üõ°Ô∏è ZAP DAST Scan with AI Analysis

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 2 * * 1" # Runs every Monday at 02:00 UTC

env:
  TARGET_URL: ${{ vars.TARGET_URL }}
  RULES_FILE: .zap/rules.tsv

jobs:
  zap-scan-and-analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      # --- Python Setup & Caching ---
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üì¶ Cache Pip Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: ‚öôÔ∏è Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --- 1. OWASP ZAP Scan ---
      - name: üõ°Ô∏è Run ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: ${{ env.RULES_FILE }}
          cmd_options: >
            -m 10
            -r zap_report.html
            -J zap_report.json
            -a
          fail_action: false

      # --- 2. Fix Permissions ---
      - name: ‚öôÔ∏è Fix Report Permissions
        run: |
          sudo chmod 666 zap_report.json zap_report.html
          ls -lh zap_report.*

      # --- 3. AI Analysis (Gemini) ---
      - name: ü§ñ Run Gemini AI Security Analyst
        if: always()
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python ai_analyst.py zap_report.json

      # --- 4. Upload Artifacts ---
      - name: ‚¨ÜÔ∏è Upload DAST Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-security-reports
          path: |
            zap_report.html
            zap_report.json
            ai_report.json

      # --- 5. Slack Notification (ZAP Artifacts Only) ---
      - name: üîî Send ZAP Report to Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python - <<'EOF'
          import json
          import urllib.request
          import os

          run_id = os.environ["GITHUB_RUN_ID"]
          repo = os.environ["GITHUB_REPOSITORY"]

          artifact_url = f"https://github.com/{repo}/actions/runs/{run_id}"

          message = (
              "üõ°Ô∏è *OWASP ZAP DAST Scan Completed*\n\n"
              "üì¶ *ZAP Reports Generated*\n"
              "‚Ä¢ HTML Report: zap_report.html\n"
              "‚Ä¢ JSON Report: zap_report.json\n\n"
              "‚¨áÔ∏è *Download Reports*\n"
              f"{artifact_url}\n\n"
              "üìå Navigate to **Artifacts ‚Üí dast-security-reports**"
          )

          payload = {
              "channel": "#reports",
              "username": "ZAP Security Scanner",
              "icon_emoji": ":shield:",
              "text": message
          }

          req = urllib.request.Request(
              os.environ["SLACK_WEBHOOK_URL"],
              data=json.dumps(payload).encode("utf-8"),
              headers={"Content-Type": "application/json"}
          )

          urllib.request.urlopen(req)
          print("‚úÖ Slack notification sent to #reports")
          EOF
