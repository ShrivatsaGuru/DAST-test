name: ðŸ›¡ï¸ Standard DAST Scan

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 2 * * 1" # Runs every Monday at 02:00 UTC

# Define environment variables used throughout the job
env:
  # The target URL is expected to be set as a repository Variable (Settings -> Variables)
  TARGET_URL: ${{ vars.TARGET_URL }} 
  # Use a standard rules file to ignore false positives or low-info issues
  RULES_FILE: .zap/rules.tsv
  
jobs:
  zap-scan:
    runs-on: ubuntu-latest
    permissions:
      # Required to file issues/alerts if you enable that feature
      contents: read
      issues: write 
    
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      # --- Python Caching for Speed (If you have a requirements.txt) ---
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ“¦ Cache Pip Dependencies
        id: cache-pip
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-pip-cache-${{ hashFiles('requirements.txt') }}
          path: ~/.cache/pip

      - name: âš™ï¸ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --cache-dir ~/.cache/pip
      # -----------------------------------------------------------------

      # 1. Run the OWASP ZAP Full Scan
      # NOTE: action-full-scan performs attacks. Only run against systems you own!
      - name: ðŸ›¡ï¸ Run ZAP Full Scan
        id: zap_scan
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: ${{ vars.TARGET_URL }}
          rules_file_name: .zap/rules.tsv
          cmd_options: >-
            -m 10             
            -r zap_report.html
            -J zap_report.json # <-- This file will be read next
            -a
          fail_action: false # Allow subsequent steps to run even if ZAP finds issues

      # 2. Fix Permissions (Crucial step to read file created by Docker)
      - name: âš™ï¸ Fix Report File Permissions
        run: |
          chmod a+rw zap_report.json
          ls -l zap_report.json
          
      # 3. AI Analysis and Remediation (New Step)
      - name: ðŸ¤– Run Gemini AI Security Analyst
        env:
          # Pass the Gemini Key as a secret
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} 
        run: |
          # The script reads zap_report.json and creates ai_report.json
          python ai_analyst.py zap_report.json

      # 4. Upload All Reports (Original ZAP + New AI Report)
      - name: â¬†ï¸ Upload DAST Reports
        uses: actions/upload-artifact@v4
        with:
          name: dast-scan-reports
          path: |
            zap_report.html
            zap_report.json
            ai_report.json # <-- Upload the new AI-generated report

      # 3. Use the Report (Example: Simple Slack Notification)
      # This step runs your custom Python script to send a basic notification.
      - name: ðŸ“¢ Send Simple Slack Notification
        if: always() # Run even if the ZAP step above failed (to report the failure)
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL }}
        run: |
          # Use a simple Python command to notify about the pipeline status
          if [ $? -ne 0 ]; then
            REPORT_STATUS="FAILED: High/Critical issues found!"
          else
            REPORT_STATUS="PASSED: No critical issues found."
          fi
          
          echo "Sending notification..."
          # Replace this with your actual Python script if needed, 
          # or a simple curl command for generic notifications:
          python send_notification.py "${REPORT_STATUS}" "${TARGET_URL}"
