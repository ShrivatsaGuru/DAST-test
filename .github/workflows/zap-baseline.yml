name: ZAP Full DAST Scan and AI Reporting

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 2 * * 1" # Run every Monday at 02:00 UTC

jobs:
  ai-dast-report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      # 1. Caching and Python Setup (Step 1)
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üì¶ Cache Python Dependencies
        id: cache-pip
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          path: ${{ env.pythonLocation }}

      - name: ‚öôÔ∏è Install Python Dependencies (If Cache Missed)
        if: steps.cache-pip.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 2. Perform OWASP ZAP Full Scan (Step 2)
      - name: üõ°Ô∏è Run ZAP Full Scan
        id: zap_scan
        uses: zaproxy/action-full-scan@v0.13.0 # Using latest stable version
        with:
          # Use the TARGET_URL variable from your GitHub Environment
          target: ${{ vars.TARGET_URL }}
          rules_file_name: .zap/rules.tsv
          cmd_options: '-m 10 -r report.html -J report.json' # Scan for 10 mins, output HTML/JSON
          allow_issue_writing: false
          fail_action: false
          
      - name: ‚öôÔ∏è Fix Report File Permissions
        run: |
          # The 'chmod a+rw' command gives ALL users (a) read and write (+rw) 
          # permission to the report file created by the Docker container.
          chmod a+rw report.json
          # Optionally, check to see the permissions are correct (for debugging)
          ls -l report.json


      # 4. AI Processing and Slack Reporting (Steps 3 & 4)
      - name: ü§ñ Send AI-Powered Slack Report with Remediation
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL || '#security-alerts' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USE_AI_CLASSIFICATION: true
        run: |
          cat report.json | python slack_reporter_full.py javascript
